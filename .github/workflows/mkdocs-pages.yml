name: Deploy MkDocs (+ Log4brains ADRs)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  ADR_LOCAL_DIR: adr
  L4B_BASE_PATH: /adr-l4b   # no trailing slash

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # Log4brains install & build (safe even if adr/ missing)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Log4brains
        run: |
          if [ -d "${ADR_LOCAL_DIR}" ]; then
            echo "Installing Log4brains in ${ADR_LOCAL_DIR}"
            cd "${ADR_LOCAL_DIR}"
            npm pkg set private=false >/dev/null 2>&1 || true
            npm install --save-dev log4brains@latest
          else
            echo "No ${ADR_LOCAL_DIR}/ directory found; skipping L4B install."
          fi

      - name: Build Log4brains
        run: |
          if [ -d "${ADR_LOCAL_DIR}" ]; then
            echo "Building Log4brains with basePath=${L4B_BASE_PATH}"
            cd "${ADR_LOCAL_DIR}"
            npx -y log4brains@latest build --basePath "${L4B_BASE_PATH}" || echo "L4B build failed or produced no output."
            echo "Listing possible outputs:"
            ls -la .log4brains/out 2>/dev/null || echo "no .log4brains/out"
            ls -la site 2>/dev/null || echo "no legacy site"
          else
            echo "No ${ADR_LOCAL_DIR}/ directory found; skipping L4B build."
          fi

      - name: Embed L4B output into MkDocs
        run: |
          mkdir -p docs/adr-l
